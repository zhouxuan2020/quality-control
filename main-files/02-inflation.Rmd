
# Good VS Bad GWAS

Here we investigate the inflation in test statistics from the bad GWASs. We want to find out 1) if the inflation is constant; 2) if it can be predicted in some way.  

## test statistics ~ LD score

The inflation in GWAS test statistics due to confouding is not always constant, as assumed by LDSC. Below we plotted the chi-square test statistics from the bad (colored in red), good (orange), and control (gray) GWASs as a function of LD score ( Fig \@ref(fig:good-vs-bad-by-ldscorebin) ). The linear model assumed by LDSC is only appropriate for four traits, namely chron, pulse, quals, and snoring. For these traits, LDSC accounts for the inflation due to confouding (i.e., intercept) and the inflation due to polygenity (i.e., slope). However, LDSD is inadequate for other traits, where the inflation is non-linear. More specifically, for these traits, the test statistics for SNPs with a low LD score are much more inflated than would be expected by LDSC. Thus, it seems that ldsc can detect inflation in test statistics due to confouding but cannot be used to correct the inflation for some traits.

```{r eval=F, echo=F}
# gwas test statistics
library(vroom)

trait="neur" # bmi
good=vroom(paste0("unrelated/gwas-good/",trait,"-linear.summaries"), col_names=T)
bad=vroom(paste0("gwas-mix/",trait,"-linear.summaries"), col_names=T)
control=vroom(paste0("gwas-control/",trait,"-linear.summaries"), col_names=T)
# note: stat = chi-square test statistic
common=intersect(good$Predictor, bad$Predictor)
common=intersect(common, control$Predictor) # 110,2693 in common
m1=match(common,good$Predictor)
m2=match(common,bad$Predictor)
m3=match(common,control$Predictor)
all=data.frame(Predictor=common, 
               good=good$Stat[m1], 
               bad=bad$Stat[m2], 
               control=control$Stat[m3], stringsAsFactors = F)

# plots 
end=round(max(c(all$good, all$bad)),0)+1
start=round(min(c(all$good, all$bad)),0)
#good vs. bad
png(paste0("fig/",trait,"-gwas-stat-good-vs-bad.png"),
    width =40, height = 20, units = "cm", res=600)
par(mfrow=c(1,2))
plot(all$good, all$bad,
     xlab="good-chisq", ylab="bad-chisq", 
     xlim=c(start, end), 
     ylim=c(start, end),
     main=trait, las=1,
     cex = 1, pch=21,  bg="darkgray", col="white", lwd=0.5)
#points(good[fs],bad[fs],cex = 1, pch=21, col="white", bg="orange")
abline(0, 1, col="darkgray", lwd=1.5, lty=1)
#abline(h=threshold, col="red", lwd=1.5, lty=3)
#abline(v=threshold, col="red", lwd=1.5, lty=3)

# good vs. control
plot(all$good, all$control,
     xlab="good-chisq", ylab="control-chisq", 
     xlim=c(start, end), 
     ylim=c(start, end),
     main=trait, las=1,
     cex = 1, pch=21,  bg="darkgray", col="white", lwd=0.5)
#points(good[fs],bad[fs],cex = 1, pch=21, col="white", bg="orange")
abline(0, 1, col="darkgray", lwd=1.5, lty=1)
dev.off()

```

```{r good-vs-bad, fig.cap='Test statistics of bad and good GWASs', fig.show='hold', out.width='100%', fig.asp=0.75, fig.align='left', echo=F, eval=F}
knitr::include_graphics(c("fig-to-insert/bmi-gwas-stat-good-vs-bad.png",
                          "fig-to-insert/neur-gwas-stat-good-vs-bad.png" ))
```

```{bash eval=F, echo=F}
#::::
# organize data
#::::

# 1. get overlapping SNPs across GWASs
cp gen/snps-control-gwas.use temp #1,103,182
awk '(NR==FNR){a[$1];next}($1 in a){print $1}' temp gen/snps-unrel-inds.use > overlap-control-good-bad.snps
mv overlap-control-good-bad.snps temp
awk '(NR==FNR){a[$1];next}($1 in a){print $2}' temp doug/ukbb.ldsc > overlap-control-good-bad.snps
wc -l overlap-control-good-bad.snps # 1,102,693 SNPs in common

# 2. get ld scores for overlapping snps
dir=ldsc/eur_w_ld_chr
for chrom in {1..22}; do
zcat $dir/$chrom.l2.ldscore.gz | awk 'NR>1 {print $2, $6}' > ldscore
awk '(NR==FNR){a[$1];next}($1 in a){print $0}' overlap-control-good-bad.snps ldscore > temp
if [ $chrom -eq 1 ]
then 
 mv temp overlap-control-good-bad.ldscore
else
 cat overlap-control-good-bad.ldscore temp > temp2
 mv temp2 overlap-control-good-bad.ldscore
fi
echo $chrom
done

# 3. get test statistics of GWASs 
dir1="ldsc/out-control/"
dir2="ldsc/out-good-gwas/"
dir3="ldsc/out-mix-pop/"

require("vroom")
snps=vroom("overlap-control-good-bad.ldscore", col_names=F)
traits=c("awake","bmi","chron","ever",
        "neur","pulse","quals",
        "reaction","sbp","snoring","hyper")
# c("fcv", "height","imp")
for(i in 1:length(traits)){
  
  trait=traits[i]
  dat1=vroom(paste0(dir1,trait,".sumstats.gz"), col_names=T)
  dat2=vroom(paste0(dir2,trait,".sumstats.gz"), col_names=T)
  dat3=vroom(paste0(dir3,trait,".sumstats.gz"), col_names=T)
  m1=match(snps$X1, dat1$SNP)
  m2=match(snps$X1, dat2$SNP)
  m3=match(snps$X1, dat3$SNP)
  out=data.frame(SNP=snps$X1,
                 ldscore=snps$X2,
                  control_chisq=dat1$Z[m1]^2,
                  good_chisq=dat2$Z[m2]^2,
                  bad_chisq=dat3$Z[m3]^2, stringsAsFactors = F)
  out=out[complete.cases(out),]
  # bin LD scores according to quantiles
  cutoff=quantile(out$ldscore, probs = seq(0, 1, 0.005))
  out$ldsc_bin=cut(out$ldscore, breaks=cutoff, labels=1:(length(cutoff)-1))
  write.table(out,paste0("summary/",trait,"-gwas-test-stats-compare.txt"), 
              col.names=T, row.names=F, quote=F)
}

#::::
# plot by ldscore bin
#::::

require("vroom")
traits=c("awake","bmi","chron","ever",
        "neur","pulse","quals",
        "reaction","sbp","snoring","hyper")
# c("fcv", "height","imp")

png(paste0("fig/gwas-stat-by-ldscbin.png"),
    width =40, height = 30, units = "cm", res=1000)
par(mfrow=c(3,4))
for(i in 1:length(traits)){
trait=traits[i]
dat=vroom(paste0("summary/",trait,"-gwas-test-stats-compare.txt"), col_names=T)
out=data.frame(ave_ldscore=tapply(dat$ldscore,INDEX=dat$ldsc_bin, mean),
               ave_control_chisq=tapply(dat$control_chisq,INDEX=dat$ldsc_bin, mean),
               ave_good_chisq=tapply(dat$good_chisq,INDEX=dat$ldsc_bin, mean),
               ave_bad_chisq=tapply(dat$bad_chisq,INDEX=dat$ldsc_bin, mean))

end=round(max(c(out[,2], out[,3], out[,4])),0)
start=0
plot(out$ave_ldscore, out$ave_control_chisq,
     xlab="ldscore bin", ylab="mean chisquare", 
     ylim=c(start, end),
     main=trait, las=1,
     cex = 1.5, pch=21,  bg="gray", col="white", lwd=0.5)
points(out$ave_ldscore, out$ave_good_chisq,
       cex = 1.5, pch=21, col="white", bg="orange")
points(out$ave_ldscore, out$ave_bad_chisq,
       cex = 1.5, pch=21, col="white", bg="red")

}
dev.off()

#:::
# plot by raw ldscores
#:::
require("vroom")

traits=c("bmi", "neur")

for(i in 1:length(traits)){
  
trait=traits[i]
dat=vroom(paste0("summary/",trait,"-gwas-test-stats-compare.txt"), col_names=T)

png(paste0("fig/",trait,"-gwas-stat-by-ldscore.png"),
    width =20, height = 20, units = "cm", res=600)

end=round(max(c(dat$control_chisq, dat$good_chisq, dat$bad_chisq)),0)+1
start=0
plot(dat$ldscore, dat$bad_chisq,
     xlab="ldscore", ylab="chisq", 
     ylim=c(start, end),
     main=trait, las=1,
     cex = 1, pch=21,  bg="red", col="white", lwd=0.5)
points(dat$ldscore, dat$control_chisq,
       cex = 1, pch=21, col="white", bg="orange")
points(dat$ldscore, dat$good_chisq,
       cex = 1, pch=21, col="green", bg="red")

dev.off()
}

```

```{r good-vs-bad-by-ldscorebin, fig.cap='Test statistics by LD score for good, bad and control GWASs.', fig.show='hold', out.width='100%', fig.asp=0.75, fig.align='left', echo=F}
knitr::include_graphics(c("fig-to-insert/gwas-stat-by-ldscbin.png"))
                        
```



